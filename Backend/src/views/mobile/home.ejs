<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Smart Parking - Mobile</title>
    <link rel="stylesheet" href="<%= baseUrl %>/stylesheets/mobile.base.css">
    <link rel="stylesheet" href="<%= baseUrl %>/stylesheets/mobile.home.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link rel="icon" type="image/x-icon" href="<%= baseUrl %>/images/logo-white.png">
    <script src="<%= baseUrl %>/scripts/mobile.functions.js"></script>
</head>

<body>

    <div id="load"></div>

    <div id="mobile">
        <div id="header">
            <h1>Smart Parking</h1>
            <input type="checkbox" name="" id="dark-mode-btn">
            <h1 id="logout" class="bi bi-box-arrow-left"></h1>
        </div>

        <section>
            <h3>Simulación de reservas</h3>
            <div>
                <button id="button1">Solicitar reserva</button>
                <button id="button2">Cancelar reserva</button>
                <button id="button3">Marcar llegada</button>
            </div>
        </section>

        <section>
            <h3>Simulación de ingreso y salida</h3>
            <div>
                <button id="button4">Solicitar ingreso</button>
                <button id="button5">Marcar salida</button>
            </div>
        </section>

        <section>
            <h3>Respuesta del servidor</h3>
            <div id="response"></div>
        </section>
    </div>
</body>

<script src="/socket.io/socket.io.js"></script>

<script>

    window.addEventListener("load", async (e) => {

        const load = document.getElementById('load')
        const mobile = document.getElementById('mobile')

        e.preventDefault();
        const token = localStorage.getItem("token");

        if (!token) {
            window.location.href = "<%= baseUrl %>/api/mobile";
        }

        const res = await fetch("<%= baseUrl %>/api/auth/confirm-session", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
        });

        if (!res.ok) {
            window.location.href = "<%= baseUrl %>/api/mobile";
        }

        mobile.style.display = "flex";
        load.style.display = "none";
    });

    const socket = io("<%= baseUrl %>")
    const button = document.getElementById("button1")
    const button2 = document.getElementById("button2")
    const button3 = document.getElementById("button3")
    const button4 = document.getElementById("button4")
    const button5 = document.getElementById("button5")
    const logoutbtn = document.getElementById("logout")

    logoutbtn.addEventListener("click", async (e) => {

        const token = localStorage.getItem("token")

        const res = await fetch("<%= baseUrl %>/api/auth/logout", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
        })

        if (res.ok) {
            localStorage.removeItem("token")
            window.location.href = "<%= baseUrl %>/api/mobile";

        } else {
            setResponse("Error al cerrar sesión")
        }
    })

    button.addEventListener("click", async (event) => {

        event.preventDefault()
        const token = localStorage.getItem("token")
        socket.emit("user-reservation-req", { token, patente: "ACXB42" })
    })

    button2.addEventListener("click", async (event) => {

        event.preventDefault()
        const token = localStorage.getItem("token")
        socket.emit("user-cancel-reservation", { token, patente: "ACXB42" })
    })

    button3.addEventListener("click", async (event) => {

        event.preventDefault()
        const token = localStorage.getItem("token")
        socket.emit("user-reservation-arrival", { token, patente: "ACXB42" })
    })

    button4.addEventListener("click", async (event) => {

        event.preventDefault()
        const token = localStorage.getItem("token")
        socket.emit("user-access-req", { token, patente: "ACXB42" })
    })

    button5.addEventListener("click", async (event) => {

        event.preventDefault()
        const token = localStorage.getItem("token")
        socket.emit("user-exit-req", { token, patente: "ACXB42" })
    })

    socket.on("reservation-ok", ({ message }) => {
        setResponse(message)
    })

    socket.on("reservation-denied", ({ message }) => {
        setResponse(message)
    })

    socket.on("reservation-cancel-ok", ({ message }) => {
        setResponse(message)
    })

    socket.on("reservation-cancel-denied", ({ message }) => {
        setResponse(message)
    })

    socket.on("reservation-arrival-ok", ({ message }) => {
        setResponse(message)
    })

    socket.on("reservation-arrival-denied", ({ message }) => {
        setResponse(message)
    })

    socket.on("parking-access-ok", ({ message }) => {
        setResponse(message)
    })

    socket.on("parking-access-denied", ({ message }) => {
        setResponse(message)
    })

    socket.on("parking-exit-ok", ({ message }) => {
        setResponse(message)
    })

    socket.on("parking-exit-denied", ({ message }) => {
        setResponse(message)
    })

</script>

</html>